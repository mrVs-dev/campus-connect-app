rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Super admin rule: Grants the owner full access to everything.
    function isSuperAdmin() {
      return request.auth.token.email == 'vannak@api-school.com';
    }

    // This rule gives the super admin unconditional access to all documents.
    match /{document=**} {
      allow read, write: if isSuperAdmin();
    }

    // Allow authenticated users to read essential collections for app startup.
    // This helps prevent race conditions for regular users.
    match /(students|admissions|assessments|teachers|student_status_history|fees|invoices|inventory|users)/{docId} {
      allow read: if request.auth != null;
    }
    
    // Allow read access to the settings documents for any authenticated user.
    match /settings/{setting} {
      allow read: if request.auth != null;
    }

    // More granular rules can be added below for other users.
    // The isSuperAdmin check will always take precedence for the owner.
  }
}
